{% extends 'base.html' %}
{% block title %}{{title}} | {{block.super}}{% endblock %}
{% load static %}
{% block page_css %}
<!-- Ekko Lightbox -->
  <link rel="stylesheet" href="{% static 'plugins/ekko-lightbox/ekko-lightbox.css' %}">
  <style>
    .task-card{
        cursor:grab;
    }
    .form-group{
      display: flex;
    }
    #backlog h3{
      margin: 10px;
    }
  </style>
  {% endblock %}
{% block content %}
<div class="container-fluid h-100">
        <div class="card card-row card-secondary board-column" id="backlog">
          <div class="card-header">
            <h3 class="card-title">
              Backlog
            </h3>
            <form action="{% url 'tasks:create_task_ajax' %}" id="create-task-form" data-project-id="{{project.id}}" method="post">
             {% csrf_token %}
              <div class="form-group">
                <input type="text" id="task-name" name="name" class="form-control task-input" placeholder="New Task">
              </div>
            </form>
          </div>
          <div class="card-body task-list">
            {% for task in backlog_tasks %}
            <div class="card card-secondary card-outline task-card" data-task-id="{{task.id}}">
              <div class="card-header">
                <h5 class="card-title">{{task.name}}</h5>
                <div class="card-tools">
                  <a href="#" class="btn btn-tool btn-link task-counter"></a>
                  <a href="#" class="btn btn-tool">
                    <i class="fas fa-pen"></i>
                  </a>
                </div>
              </div>

              {% if task.description %}
              <div class="card-body">
                <p class="card-description">
                  {{task.description}}
                </p>
              </div>
              {% endif %}

            </div>
            {% endfor %}
          </div>
        </div>
        <div class="card card-row card-primary board-column" id="to-do">
          <div class="card-header">
            <h3 class="card-title">
              To Do
            </h3>
          </div>
          <div class="card-body task-list">
            {% for task in todo_tasks %}
            <div class="card card-primary card-outline task-card" data-task-id="{{task.id}}">
              <div class="card-header">
                <h5 class="card-title">{{task.name}}</h5>
                <div class="card-tools">
                  <a href="#" class="btn btn-tool btn-link">#{{forloop.counter}}</a>
                  <a href="#" class="btn btn-tool">
                    <i class="fas fa-pen"></i>
                  </a>
                </div>
              </div>
              {% if task.description %}
              <div class="card-body">
                <p class="card-description">
                  {{task.description}}
                </p>
              </div>
              {% endif %}
            </div>
            {% endfor %}
          </div>
        </div>
        <div class="card card-row card-default board-column" id="in-progress">
          <div class="card-header bg-info">
            <h3 class="card-title">
              In Progress
            </h3>
          </div>
          <div class="card-body task-list">
            {% for task in inprogress_tasks %}
            <div class="card card-primary card-outline task-card" data-task-id="{{task.id}}">
              <div class="card-header">
                <h5 class="card-title">{{task.name}}</h5>
                <div class="card-tools">
                  <a href="#" class="btn btn-tool btn-link">#{{forloop.counter}}</a>
                  <a href="#" class="btn btn-tool">
                    <i class="fas fa-pen"></i>
                  </a>
                </div>
              </div>
              {% if task.description %}
              <div class="card-body">
                <p class="card-description">
                  {{task.description}}
                </p>
              </div>
              {% endif %}
            </div>
            {% endfor %}
          </div>
        </div>
        <div class="card card-row card-success board-column" id="completed">
          <div class="card-header">
            <h3 class="card-title">
              Done
            </h3>
          </div>
          <div class="card-body task-list">
            {% for task in completed_tasks %}
            <div class="card card-success card-outline task-card" data-task-id="{{task.id}}">
              <div class="card-header">
                <h5 class="card-title">{{task.name}}</h5>
                <div class="card-tools">
                  <a href="#" class="btn btn-tool btn-link">#{{forloop.counter}}</a>
                  <a href="#" class="btn btn-tool">
                    <i class="fas fa-pen"></i>
                  </a>
                </div>
              </div>
              {% if task.description %}
              <div class="card-body">
                <p class="card-description">
                  {{task.description}}
                </p>
              </div>
              {% endif %}
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% include 'tasks/task_update_modal.html' %}
{% endblock %}

{% block script %}
<script>
    document.addEventListener('DOMContentLoaded',function(){
        const taskCards = document.querySelectorAll('.task-card')
        taskCards.forEach(card =>{
            card.draggable = true

        card.addEventListener('dragstart',(e)=>{
            e.dataTransfer.setData('text/plain',card.dataset.taskId);
            console.log(card.dataset)
        })
        })
        const columns = document.querySelectorAll('.board-column')
        columns.forEach(column=>{
            column.addEventListener('dragover',(e)=>{
                e.preventDefault()

                column.addEventListener('drop',(e)=>{
                    const taskId = e.dataTransfer.getData('text/plain');
                    const taskCard = document.querySelector(`[data-task-id="${taskId}"]`)
                    //get new status
                    const newStatus = column.id.replace('-', ' ');
                    // move the task card to new column
                    column.querySelector('.task-list').prepend(taskCard)
                    // update the class or column based on color
                    taskCard.classList.remove('card-success','card-primary','card-default','card-secondary','card-light')
                    if(column.id === 'backlog'){
                      taskCard.classList.add('card-secondary')
                    }else if(column.id === 'to-do'){
                      taskCard.classList.add('card-primary')
                    }else if(column.id === 'in-progress'){
                      taskCard.classList.add('card-primary')
                    }else if(column.id === 'completed'){
                      taskCard.classList.add('card-success')
                    }
                    // send ajax request to update task status
                    updateTaskStatus(taskId,newStatus)
                })
            })
        })
        // update status ajax
        function updateTaskStatus(taskId,newStatus){
          fetch(`/tasks/update_task_status_ajax/${taskId}/`,{
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({status: newStatus}),
          })
          .then(response=>response.json())
          .then(data=>{
            if(data.success){
              console.log('Task updated')
            }else{
              console.error('Updating failed')
            }
          });
        }
        // submit form
        const taskForm = document.getElementById('create-task-form');
        const taskInput = document.getElementById('task-name');
        const projectId = taskForm.getAttribute('data-project-id');
        // get backlog
        const BacklogColumn = document.getElementById('backlog')

        if(taskForm && taskInput && projectId){
          taskInput.addEventListener('keydown', function (event){
            if (event.key === 'Enter'){
              event.preventDefault()
              const taskName = taskInput.value.trim();
              if (taskName){
                const formData = new FormData(taskForm)
                formData.append('name',taskName)
                formData.append('project_id',projectId)

                fetch(taskForm.action,{
                  method: taskForm.method,
                  body: formData,
                  headers:{
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                  }
                })
                .then(response => response.json())
                .then(data => {
                  if(data.success){
                    console.log("Success",data.task_id)
                    taskInput.value = '';
                    // add task to column without refresh
                    const newTaskCard = document.createElement('div')
                    newTaskCard.classList.add('card', 'card-secondary', 'card-outline', 'task-card');
                    newTaskCard.setAttribute('data-task-id',data.task_id)
                    newTaskCard.draggable = true
                    // add task content
                    newTaskCard.innerHTML = `
                    <div class="card-header">
                <h5 class="card-title">${taskName}</h5>
                <div class="card-tools">
                  <a href="#" class="btn btn-tool btn-link task-counter"></a>
                  <a href="#" class="btn btn-tool">
                    <i class="fas fa-pen"></i>
                  </a>
                </div>
              </div>
                    `;
                    // append the newly created task to the column
                    const backlogTaskList = BacklogColumn.querySelector('.task-list')
                    backlogTaskList.prepend(newTaskCard)
                    // updating counter refresh
                    updateTaskCounter()
                    // addeventlistner for drag and drop
                    newTaskCard.addEventListener('dragstart',(e)=>{
                      e.dataTransfer.setData('text/plain',newTaskCard.dataset.taskId)

                    })
                  }else{
                    console.error('Error: ',data.error)
                  }
                })
                .catch(error => {
                  console.log("Error creating task: ",error)
                })
              }else{
                console.log("Task empty")
              }
            }
          })
        }else{
          console.log("Project id, form, input not present")
        }
        // update counter
        function updateTaskCounter(){
          const taskCards = BacklogColumn.querySelectorAll('.task-card')
          taskCards.forEach((card,index)=>{
            const taskCounter = card.querySelector('.task-counter')
            if(taskCounter){
              taskCounter.textContent = `#${index+1}`
            }
          })
        }
        //calling update task counter on page load
        updateTaskCounter();
        // edit the project with click the icon
        const taskUpdateModal = document.getElementById('taskUpdateModal')
        const editIcons = document.querySelectorAll('.fa-pen');
        let currentTaskId = null
        editIcons.forEach(icon => {
          icon.addEventListener('click', function(event){
            event.preventDefault();
            // get task id
            currentTaskId = this.closest('.task-card').dataset.taskId          
            
            // make ajax for fetching data
            fetch(`/tasks/${currentTaskId}/get/`,{
              method: 'GET',
              headers: {
                'Content-Type':'application/json'
              }
            })
            .then(response => response.json())
            .then(data => {
              if(data.error){
                console.log(data.error)
              }else{
                task = data.task_data
                taskUpdateModal.querySelector('input[name="task_id"]').value = task.id;
                taskUpdateModal.querySelector('input[name="name"]').value = task.name;
                taskUpdateModal.querySelector('textarea[name="description"]').value = task.description;
                taskUpdateModal.querySelector('select[name="priority"]').value = task.priority;
                taskUpdateModal.querySelector('input[name="start_date"]').value = task.start_date;
                taskUpdateModal.querySelector('input[name="due_date"]').value = task.due_date;
                $('#taskUpdateModal').modal('show')
              }
            })
            .catch(error => console.error('Error fetching data:', error));
          })
        });
        // updating task
        const form = document.getElementById('taskUpdateForm')
        form.addEventListener('submit',function(event){
          event.preventDefault();
          const formData = new FormData(form);
          fetch(`/tasks/${currentTaskId}/update/`,{
            method: 'POST',
            body: formData,
            headers:{
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
          })
          .then(response => response.json())
          .then(data => {
            if(data.success){
              document.querySelector(`.task-card[data-task-id='${currentTaskId}'] .card-title`).textContent = data.updatedTask.name;
              document.querySelector(`.task-card[data-task-id='${currentTaskId}'] .card-description`).textContent = data.updatedTask.description;
              // find taskcard
              const taskCard = document.querySelector(`.task-card[data-task-id='${currentTaskId}']`)
              // check if taskcard exists
              if(taskCard){
                taskCard.querySelector('.card-title').textContent = data.updatedTask.name;
                // check if description exists
                let descriptionElement = taskCard.querySelector('.card-description');
                if(descriptionElement){
                  descriptionElement.textContent = data.updatedTask.description
                }
              }
              // hide task update modal
            $('#taskUpdateModal').modal('hide')
            }else{
              console.log('error updating task: ',data.error)
            }
          })
          .catch(error => console.error("Error: ",error))
        })
    })
</script>
{% endblock %}